<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>TiDB Document Japanese</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="01_preface.html"><strong aria-hidden="true">1.</strong> 序文</a></li><li class="chapter-item expanded "><a href="02_about_tidb/01_about.html"><strong aria-hidden="true">2.</strong> TiDBについて</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="02_about_tidb/01_about.html"><strong aria-hidden="true">2.1.</strong> TiDBとは何か？</a></li><li class="chapter-item expanded "><a href="02_about_tidb/02_whats-new-in-tidb-4.0.html"><strong aria-hidden="true">2.2.</strong> 4.0の新しい特徴</a></li></ol></li><li class="chapter-item expanded "><a href="03_main_concept/01_main_structure.html"><strong aria-hidden="true">3.</strong> メイン概念</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="03_main_concept/01_main_structure.html"><strong aria-hidden="true">3.1.</strong> メイン構造</a></li></ol></li><li class="chapter-item expanded "><a href="blog/tidb-wasm.html"><strong aria-hidden="true">4.</strong> ブロック</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="blog/tidb-wasm.html"><strong aria-hidden="true">4.1.</strong> TiDB-Wasm 原理と実現</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">TiDB Document Japanese</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#tidb-ドキュメント" id="tidb-ドキュメント">TiDB ドキュメント</a></h1>
<h2><a class="header" href="#序文" id="序文">序文</a></h2>
<p><code>TiDB</code>は、<a href="https://pingcap.com/en/">PingCAP</a> 研究開発の分散型データベースである。<code>TiDB</code>は<code>MySQL</code>プロトコルと互換性がある、<code>MySQL</code>ユーザーにとって使いやすいことである。</p>
<h2><a class="header" href="#公式ドキュメント" id="公式ドキュメント">公式ドキュメント</a></h2>
<p>以下は中国語公式ドキュメントと英語公式ドキュメントのリンクである。中国語または英語が上手く方は直接に読むことはおすすめです。</p>
<ul>
<li>
<p><a href="https://docs.pingcap.com/zh/tidb/stable">中国語</a></p>
</li>
<li>
<p><a href="https://docs.pingcap.com/tidb/stable">英語</a></p>
</li>
</ul>
<h2><a class="header" href="#日本語ドキュメントについて" id="日本語ドキュメントについて">日本語ドキュメントについて</a></h2>
<p>この通訳は個人的な趣味で、<a href="https://github.com/you06">自分</a>と<a href="https://github.com/SakuramiRin">SakuramiRin</a>様はメンテナンスしています。日本語の初心者なので、説明または構文が不適切な場合、プルリクエストや以下のメールをいただければ心より感谢します。</p>
<ul>
<li><a href="mailto:tongmu@pingcap.com">tongmu@pingcap.com</a></li>
</ul>
<h2><a class="header" href="#バージョン" id="バージョン">バージョン</a></h2>
<p>現在<code>TiDB</code>のステェィブルバージョンは三つである。</p>
<ul>
<li>
<p><a href="https://github.com/pingcap/tidb/tree/release-4.0"><code>release-4.0</code></a>（おすすめ）</p>
</li>
<li>
<p><a href="https://github.com/pingcap/tidb/tree/release-3.1"><code>release-3.1</code></a></p>
</li>
<li>
<p><a href="https://github.com/pingcap/tidb/tree/release-3.0"><code>release-3.0</code></a></p>
</li>
</ul>
<p>三つがあるが、公式ドキュメントはどちらでも適用されます。</p>
<h2><a class="header" href="#プログレス" id="プログレス">プログレス</a></h2>
<p>あんまり時間がありませんので、通訳の進捗率は遅くになるかもしれないですが、頑張りたいとおもいます！</p>
<h2><a class="header" href="#ブログ" id="ブログ">ブログ</a></h2>
<p><code>TiDB</code>に関連するのブログ、最後の付録である。</p>
<h1><a class="header" href="#tidbの概要" id="tidbの概要">TiDBの概要</a></h1>
<p><code>TiDB</code>は、<a href="https://pingcap.com/en/">PingCAP</a> 研究開発の分散型<code>HTAP(Hybrid Transactional and Analytical Processing)</code>データベースであり、 <a href="https://ja.wikipedia.org/wiki/%E9%96%A2%E4%BF%82%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E7%AE%A1%E7%90%86%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0"><code>RDBMS</code></a>と<a href="https://ja.wikipedia.org/wiki/NoSQL"><code>NoSQL</code></a>の最高の機能を組み合わせています。<code>TiDB</code>は<code>MySQL</code>と相互運用可能であり、機能拡張性、一貫性、高可用性ような属性を持っています。<code>OLTP (Online Transactional Processing)</code>および<code>OLAP (Online Analytical Processing)</code>の場合でワンストップソリューションを提供することは目标として追求しております。</p>
<p>TiDB 特徴：</p>
<ul>
<li>
<p><code>MySQL</code>と高い互換性</p>
<p><a href="https://pingcap.com/docs/v3.0/reference/mysql-compatibility/">ほとんどの場合</a>、コードを変更せずに移植できます。もしサブデータベースとサブテーブルを使用すると、移植ツールがあってサポートします。</p>
</li>
<li>
<p>無制限の拡張機能</p>
<p>ノードを追加するだけで、パフォーマンスが無制限で拡張するになっていますし、必要なノードを拡張すれば、高並行性と大規模データのシナリオの処理は簡単になります。</p>
</li>
<li>
<p><a href="https://ja.wikipedia.org/wiki/%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">分散トランザクション</a></p>
<p><code>TiDB</code>は、標準の<a href="https://ja.wikipedia.org/wiki/ACID_(%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E7%A7%91%E5%AD%A6)"><code>ACID</code></a>トランザクションを完全にサポートしています。</p>
<p>公式ドキュメントにはこの一文しかありませんが、もう一つつたえたいのは、分散トランザクションのサポートにより、データの変更は成功になったら全てのノードがすぐに有効です。全てのノードが一つという思いがあったら良いです。</p>
</li>
<li>
<p>金融レベルな高い可用性</p>
<p>クラシックのマスタースレーブスキームに比べて、<code>Raft</code>の分散コヒーレンスプロトコルアプローチは終始一貫のことを保証します。そして、レプリカが多く存在すれば、障害が発生の時に人工の操作が要らなくて自動回復ことができます。</p>
</li>
<li>
<p>ワンストップ<code>HTAP</code>ソリューション</p>
<p><code>TiDB</code>は典型的な<code>OLTP</code>ラインアンドバンクデータベースとともに、強いの<code>OLAP</code>機能があります。<code>TiSpark</code>を配合して、1つのストレージは<code>OLTP</code>と<code>OLAP</code>を同時に処理し、面倒な<a href="https://ja.wikipedia.org/wiki/Extract/Transform/Load"><code>ETL</code></a>プロセスが要りません。</p>
</li>
<li>
<p>クラウドネイティブSQLデータベース</p>
<p>TiDBは、クラウドデータベース、パブリッククラウド、プライベートクラウド、およびハイブリッドクラウドをサポートします。展開、構成、および保守することは簡単です。</p>
</li>
</ul>
<p><code>TiDB</code>は100%の<code>OLTP</code>と80%の<code>OLAP</code>のシナリをサポートすることを目指して、複雑な<code>OLAP</code>分析が要ると<a href="02_about_tidb/01_about.html#"><code>TiSpark</code></a>を使用できます。</p>
<p><code>TiDB</code>はコードに侵入しなくて、クラシックのデータベースミドルウェアあるいはサブデータベースとサブテーブルを置換します。そして、開発者と保守業務者はデータベースのスケール問題を考え必要はなくて、ビジネスの開発ことをもと集中します。研究開発の効率性大きく向上させることがある。</p>
<h1><a class="header" href="#tidbの始める" id="tidbの始める">TiDBの始める</a></h1>
<p><code>TiDB</code>はローカルまたはクラウドプラットフォームに展開できます。パブリッククラウド、プライベートクラウド、あるいはハイブリッドクラウドもサポートできます。実際のシナリオに応じて、TiDBクラスターを展開するの方法を選択してください。</p>
<ul>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>Ansible</code>展開</a>：プロダクション運用環境で展開する場合、<code>Ansible</code>を使用して<code>TiDB</code>クラスターをデプロイしなければならない。</p>
</li>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>Ansible</code>オフライン展開</a>：デプロイメント環境がネットワークにアクセスすることができない場合は、<code>Ansible</code>オフライン展開することもできます。</p>
</li>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>TiDB Operator</code>展開</a>：<code>Kubernetes</code>環境の展開は、<code>TiDB Operator</code>使用します。<code>AWS</code>、<code>GKE</code>、<code>Aliyun</code>はサポートします。</p>
</li>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>Docker Compose</code>展開</a>：<code>TiDB</code>をテスト、<code>TiDB</code>の新たな特徴を試す、またはスタンディング環境に使用する場合は、<code>Docker Compose</code>は<code>TiDB</code>クラスターをローカルに迅速に展開することができます。（プロジェクト環境には適していません）</p>
</li>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>Docker</code>展開</a>：<code>Docker</code>を使用して<code>TiDB</code>クラスターをデプロイできます。（プロジェクト環境には適していません）</p>
</li>
</ul>
<h1><a class="header" href="#ソースコード" id="ソースコード">ソースコード</a></h1>
<ul>
<li>
<p><a href="https://github.com/pingcap/tidb">TiDB</a></p>
</li>
<li>
<p><a href="https://github.com/tikv/tikv">TiKV</a></p>
</li>
<li>
<p><a href="https://github.com/pingcap/pd">PD</a></p>
</li>
<li>
<p><a href="https://github.com/pingcap/tispark">TiSpark</a></p>
</li>
<li>
<p><a href="https://github.com/pingcap/tidb-operator">TiDB Operator</a></p>
</li>
</ul>
<h1><a class="header" href="#tidbの概要-1" id="tidbの概要-1">TiDBの概要</a></h1>
<p><code>TiDB</code>は、<a href="https://pingcap.com/en/">PingCAP</a> 研究開発の分散型<code>HTAP(Hybrid Transactional and Analytical Processing)</code>データベースであり、 <a href="https://ja.wikipedia.org/wiki/%E9%96%A2%E4%BF%82%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E7%AE%A1%E7%90%86%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0"><code>RDBMS</code></a>と<a href="https://ja.wikipedia.org/wiki/NoSQL"><code>NoSQL</code></a>の最高の機能を組み合わせています。<code>TiDB</code>は<code>MySQL</code>と相互運用可能であり、機能拡張性、一貫性、高可用性ような属性を持っています。<code>OLTP (Online Transactional Processing)</code>および<code>OLAP (Online Analytical Processing)</code>の場合でワンストップソリューションを提供することは目标として追求しております。</p>
<p>TiDB 特徴：</p>
<ul>
<li>
<p><code>MySQL</code>と高い互換性</p>
<p><a href="https://pingcap.com/docs/v3.0/reference/mysql-compatibility/">ほとんどの場合</a>、コードを変更せずに移植できます。もしサブデータベースとサブテーブルを使用すると、移植ツールがあってサポートします。</p>
</li>
<li>
<p>無制限の拡張機能</p>
<p>ノードを追加するだけで、パフォーマンスが無制限で拡張するになっていますし、必要なノードを拡張すれば、高並行性と大規模データのシナリオの処理は簡単になります。</p>
</li>
<li>
<p><a href="https://ja.wikipedia.org/wiki/%E5%88%86%E6%95%A3%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">分散トランザクション</a></p>
<p><code>TiDB</code>は、標準の<a href="https://ja.wikipedia.org/wiki/ACID_(%E3%82%B3%E3%83%B3%E3%83%94%E3%83%A5%E3%83%BC%E3%82%BF%E7%A7%91%E5%AD%A6)"><code>ACID</code></a>トランザクションを完全にサポートしています。</p>
<p>公式ドキュメントにはこの一文しかありませんが、もう一つつたえたいのは、分散トランザクションのサポートにより、データの変更は成功になったら全てのノードがすぐに有効です。全てのノードが一つという思いがあったら良いです。</p>
</li>
<li>
<p>金融レベルな高い可用性</p>
<p>クラシックのマスタースレーブスキームに比べて、<code>Raft</code>の分散コヒーレンスプロトコルアプローチは終始一貫のことを保証します。そして、レプリカが多く存在すれば、障害が発生の時に人工の操作が要らなくて自動回復ことができます。</p>
</li>
<li>
<p>ワンストップ<code>HTAP</code>ソリューション</p>
<p><code>TiDB</code>は典型的な<code>OLTP</code>ラインアンドバンクデータベースとともに、強いの<code>OLAP</code>機能があります。<code>TiSpark</code>を配合して、1つのストレージは<code>OLTP</code>と<code>OLAP</code>を同時に処理し、面倒な<a href="https://ja.wikipedia.org/wiki/Extract/Transform/Load"><code>ETL</code></a>プロセスが要りません。</p>
</li>
<li>
<p>クラウドネイティブSQLデータベース</p>
<p>TiDBは、クラウドデータベース、パブリッククラウド、プライベートクラウド、およびハイブリッドクラウドをサポートします。展開、構成、および保守することは簡単です。</p>
</li>
</ul>
<p><code>TiDB</code>は100%の<code>OLTP</code>と80%の<code>OLAP</code>のシナリをサポートすることを目指して、複雑な<code>OLAP</code>分析が要ると<a href="02_about_tidb/01_about.html#"><code>TiSpark</code></a>を使用できます。</p>
<p><code>TiDB</code>はコードに侵入しなくて、クラシックのデータベースミドルウェアあるいはサブデータベースとサブテーブルを置換します。そして、開発者と保守業務者はデータベースのスケール問題を考え必要はなくて、ビジネスの開発ことをもと集中します。研究開発の効率性大きく向上させることがある。</p>
<h1><a class="header" href="#tidbの始める-1" id="tidbの始める-1">TiDBの始める</a></h1>
<p><code>TiDB</code>はローカルまたはクラウドプラットフォームに展開できます。パブリッククラウド、プライベートクラウド、あるいはハイブリッドクラウドもサポートできます。実際のシナリオに応じて、TiDBクラスターを展開するの方法を選択してください。</p>
<ul>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>Ansible</code>展開</a>：プロダクション運用環境で展開する場合、<code>Ansible</code>を使用して<code>TiDB</code>クラスターをデプロイしなければならない。</p>
</li>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>Ansible</code>オフライン展開</a>：デプロイメント環境がネットワークにアクセスすることができない場合は、<code>Ansible</code>オフライン展開することもできます。</p>
</li>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>TiDB Operator</code>展開</a>：<code>Kubernetes</code>環境の展開は、<code>TiDB Operator</code>使用します。<code>AWS</code>、<code>GKE</code>、<code>Aliyun</code>はサポートします。</p>
</li>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>Docker Compose</code>展開</a>：<code>TiDB</code>をテスト、<code>TiDB</code>の新たな特徴を試す、またはスタンディング環境に使用する場合は、<code>Docker Compose</code>は<code>TiDB</code>クラスターをローカルに迅速に展開することができます。（プロジェクト環境には適していません）</p>
</li>
<li>
<p><a href="02_about_tidb/01_about.html#"><code>Docker</code>展開</a>：<code>Docker</code>を使用して<code>TiDB</code>クラスターをデプロイできます。（プロジェクト環境には適していません）</p>
</li>
</ul>
<h1><a class="header" href="#ソースコード-1" id="ソースコード-1">ソースコード</a></h1>
<ul>
<li>
<p><a href="https://github.com/pingcap/tidb">TiDB</a></p>
</li>
<li>
<p><a href="https://github.com/tikv/tikv">TiKV</a></p>
</li>
<li>
<p><a href="https://github.com/pingcap/pd">PD</a></p>
</li>
<li>
<p><a href="https://github.com/pingcap/tispark">TiSpark</a></p>
</li>
<li>
<p><a href="https://github.com/pingcap/tidb-operator">TiDB Operator</a></p>
</li>
</ul>
<h1><a class="header" href="#40の新しい特徴" id="40の新しい特徴">4.0の新しい特徴</a></h1>
<p><code>TiDB v4.0</code>（以下略記<code>4.0</code>）が2020年5月28日にリリースされ、使いやすさ、安定性、パーフォーマンス、セキュリティおよび機能の方が大幅に改善されました。この記事では、改善されたことの簡単にを説明します、ユーザーは、実際のユースケースに基づいて<code>4.0</code>にアップグレードするかどうかを決定する必要があります。</p>
<h2><a class="header" href="#コア機能" id="コア機能">コア機能</a></h2>
<h3><a class="header" href="#スケジューリング機能" id="スケジューリング機能">スケジューリング機能</a></h3>
<ul>
<li>ホットスポットの対応ために、より多くのメトリックが考慮されます。これによに、書き込み、読み取りトラフィックに基づくスケジューリング基準しながら、新しい<code>key</code>のメトリックは考慮する。新しいスケジューリング方法は、トラフィックのみを考慮する場合と比較して、<code>CPU</code>リソースの使用率の不均一性の問題を大幅に改善できます。詳しくは<a href="https://docs.pingcap.com/tidb/stable/tidb-scheduling">スケジューリング</a>をご覧ください。</li>
</ul>
<h3><a class="header" href="#ストレージエンジン" id="ストレージエンジン">ストレージエンジン。</a></h3>
<ul>
<li>
<p><code>TiFlash</code>は<code>Realtime HTAP</code>機能用に<code>TiDB</code>によって追加されたコンポーネントです。<code>TiFlash</code>は<code>Multi-Raft Learner</code>プロトコルを使用して<code>TiKV</code>からリアルタイムでデータリードレプリカをコピーし、行方向ストレージエンジン<code>TiKV</code>とカラム型ストレージ<code>TiFlash</code>の完全一貫性を確保します。<code>TiKV</code>と<code>TiFlash</code>を異なるマシンにデプロイして、<code>HTAP</code>リソース割り当てと分離の問題を解決できます。詳しくは<a href="https://docs.pingcap.com/tidb/stable/tiflash-overview">TiFlash</a>をご覧ください。</p>
</li>
<li>
<p><code>TiKV　v4.0</code>や新しいストレージフォーマットにある、幅の広いテーブルデータのエンコードとデコードの効率を向上させる。</p>
</li>
</ul>
<h3><a class="header" href="#tidb-dashboard" id="tidb-dashboard">TiDB Dashboard</a></h3>
<p>DBAは<code>TiDB Dashboard</code>の<code>UI</code>を介してクラスターのトポロジー、構成情報、ログ情報、ハードウェア情報、オペレーティングシステム情報、スロークエリ情報、<code>SQL</code>情報、診断レポートなど。この情報は、DBAがデータベースシステムをすばやく理解して分析するのに役立ちます。詳細は以下の通りです。</p>
<ul>
<li>
<p>クラスター情報は、<code>TiDB</code>、<code>TiKV</code>、<code>PD</code>、<code>TiFlash</code>およびインスタンスの実行状態。</p>
</li>
<li>
<p><code>Key Visualizer</code>は<code>TiDB</code>クラスターの一定期間にトラフィックに関する履歴情報を取得して、DBAが<code>TiDB</code>クラスターの使用モードとホットスポットを分析します。</p>
</li>
<li>
<p><code>SQL</code>ステートメント情報は、データベースに実行されたすべての<code>SQL</code>と、実行回数、実行時間の記録して、ユーザーがデータベースの<code>SQL</code>実行ステータスをすばやく分析し、ホットスポットを含む<code>SQL</code>を見つける。</p>
</li>
<li>
<p><code>Slow Queries</code>は、クラスターのすべてのスロークエリステートメントを取得して、問題の解決に役立ちます。</p>
</li>
<li>
<p><code>Diagnostic Report</code>は、データベースが定期的に起こりうる障害を自動的に診断し、その診断結果とクラスター関連のメトリックを診断レポートにまとめます。診断レポートはWebページであり、ブラウザに保存した後、オフラインで読むおよび共有できます。</p>
</li>
<li>
<p><code>Log Search &amp; Download</code>は、クラスターログを視覚的に把握して、DBAによるシステム問題の分析、メンテナンスの効率を向上させる。</p>
</li>
</ul>
<h3><a class="header" href="#デプロイとメンテナンスのツール" id="デプロイとメンテナンスのツール">デプロイとメンテナンスのツール</a></h3>
<p><code>TiUP</code>は、<code>TiDB 4.0</code>でリリースされたデプロイとメンテナンスのツール。<code>TiUP</code>の主な役割は<code>TiDB</code>に関連するすべてのパッケージ、コンポーネント管理、ローカルデプロイ(Playground)、クラスター管理(Cluster)、アップグレードフレームワーク(TUF)、オフラインデプロイメントなどの機能があり、<code>TiDB</code>のインストール、デプロイメント、メンテナンスをツール化し、DBAの効率を向上させる。</p>
<ul>
<li>
<p>コンポーネント管理機能は、ワンクリックのコンポーネント情報クエリ、インストール、アップグレード、アンインストールなどの機能を提供し、DBAがTiDBのすべてのコンポーネントを管理しやすくします。</p>
</li>
<li>
<p>コンポーネント管理。コンポーネント情報を照会し、クラスターを簡単にインストール、アップグレード、およびアンインストールできます。DBAにとって、<code>TiDB</code>コンポーネントの管理はよりもはるかに簡単です。</p>
</li>
<li>
<p>クラスター管理機能(Cluster)は、複数の<code>TiDB</code>クラスターの展開、拡張、縮小、アップグレード、構成変更、開始、停止、再起動、クラスターの情報を取得の機能であり。</p>
</li>
<li>
<p>ローカルデプロイ(Playground)は、<code>TiDB</code>の基本機能をすばやく体験と理解するために、ローカル環境にやすいで<code>TiDB</code>クラスターをデプロイして。注：この機能はプロダクション運用環境に使えない。</p>
</li>
<li>
<p>プライベートミラー管理(Mirror)は、もしオフィシャルのミラーアクセスできないので、TiUPはプライベートミラーを構築するための方法を提供し、オフライン展開機能を提供します。</p>
</li>
<li>
<p>パーフォーマンス試験の機能(Benchmark)は、<code>TPC-C</code>および<code>TPC-H</code>パフォーマンステストのワークロードを提供します。自動に展開と試験の機能があります。</p>
</li>
</ul>
<h3><a class="header" href="#トランザクション" id="トランザクション">トランザクション</a></h3>
<ul>
<li>
<p>ペシミスティックのトランザクションが正式なリリースして、デフォルトモードで。ペシミスティックのトランザクションは<code>Read Committed</code>の分離レベルと<code>SELECT FOR UPDATE NOWAIT</code>をサポートする。詳しくは<a href="https://docs.pingcap.com/tidb/stable/pessimistic-transaction">ペシミスティックのトランザクション</a>をご覧ください。</p>
</li>
<li>
<p>大きなトランザクションをサポートして、トランザクションのサイズ制限が<code>100 MB</code>から<code>10 GB</code>に増加しました、楽観的およびペシミスティックの両方がサポートされます。詳しくは<a href="https://docs.pingcap.com/tidb/stable/transaction-overview#transaction-size-limit">トランザクションのサイズ制限</a>をご覧ください。</p>
</li>
</ul>
<h3><a class="header" href="#sql-機能" id="sql-機能">SQL 機能</a></h3>
<ul>
<li>
<p><code>SQL</code>プラン管理の<code>SQL Bind</code>を自動キャプチャと進化をサポートする、実行プランの使いやすさと安定性を向上させます。詳しくは<a href="https://docs.pingcap.com/tidb/stable/sql-plan-management"><code>SQL</code>プラン管理</a>をご覧ください。</p>
</li>
<li>
<p>15の新しい<code>SQL Hint</code>が追加され、オプティマイザの実行プランの生成とクエリ実行時のエンジンの動作を制御します。詳しくは<a href="https://docs.pingcap.com/tidb/stable/optimizer-hints"><code>SQL Hint</code></a>をご覧ください。</p>
</li>
<li>
<p><code>SELECT INTO outfile</code>ステートメントをサポートし、テーブルデータを指定したファイルにエクスポートできます。<code>LOAD DATA</code>を使用すると、データベース間でデータを簡単にインポート/エクスポートできます。</p>
</li>
<li>
<p>カスタムシーケンスをサポートし、<code>CACHE/NO_CACHE</code>と<code>CYCLE/NO_CYCLE</code>オプションをサポート、ユーザーはシーケンスを使用してID作成できます。詳しくは<a href="https://docs.pingcap.com/tidb/stable/sql-statement-create-sequence"><code>Sequence</code></a>をご覧ください。</p>
</li>
<li>
<p>新しい<code>Flashback</code>は、誤って<code>Truncate</code>されたテーブルを復元する。</p>
</li>
<li>
<p><code>OOM</code>を回避するには、<code>Join</code>と<code>Sort</code>の中間結果をディスクに書き込みます、システムの安定性を向上させる。</p>
</li>
<li>
<p><code>EXPLAIN</code>と<code>EXPLAIN ANALYZE</code>の表示を改善して、より多くの情報を表示して、トラブルシューティングの効率を向上させます。詳しくは<a href="https://docs.pingcap.com/tidb/stable/sql-statement-explain-analyze"><code>EXPLAIN ANALYZE</code></a>と<a href="https://docs.pingcap.com/tidb/stable/sql-statement-explain"><code>EXPLAIN</code></a>をご覧ください。</p>
</li>
<li>
<p><code>Index Merge</code>をサポートする。<code>Index Merge</code>は新しいテーブルデータアクセスメソッド。単一のテーブルを含むクエリの場合、複数のインデックスデータを自動的に読み取りにオプティマイザ、その結果を合併して、パフォーマンスを向上させます。詳しくは<a href="https://docs.pingcap.com/tidb/stable/query-execution-plan#indexmerge-example"><code>Index Merge</code></a>をご覧ください。</p>
</li>
<li>
<p><code>TiDB</code>カラムを<code>AUTO_RANDOM</code>のキーの属性をサポートする。ホットスポットの問題の解決を助ける、<code>MySQL</code>ユーザーのマイグレーションのコストを節約することができる。詳しくは<a href="https://docs.pingcap.com/tidb/stable/auto-random"><code>AUTO_RANDOM</code>のキー</a>をご覧ください。</p>
</li>
<li>
<p>クラスターのトポロジー、構成情報、ログ情報、ハードウェア情報、オペレーティングシステム情報、スロークエリ情報、<code>SQL</code>情報のテーブルを追加する。DBAがデータベースシステムをすばやく理解して分析するのに役立ちます。詳しくは<a href="https://docs.pingcap.com/tidb/stable/information-schema"><code>Information Schema</code></a>と<a href="https://docs.pingcap.com/tidb/stable/information-schema-sql-diagnostics"><code>SQL Diagnosis</code></a>をご覧ください。詳細は以下の通りです。</p>
<ul>
<li>データベースシステムテーブル
<ul>
<li><code>cluster_info</code>のテーブルは、クラスターのトポロジーの情報を保存する。</li>
<li><code>cluster_log</code>のテーブルは、クラスターのログの情報を保存する。</li>
<li><code>cluster_hardware</code>と<code>cluster_hardware</code>のテーブルは、クラスターのハードウェアとオペレーティングシステムの情報を保存する。</li>
</ul>
</li>
<li>スロークエリ、<code>SQL</code>情報のテーブル
<ul>
<li><code>cluster_slow_query</code>のテーブルは、グローバルのスロークエリの情報を保存する。</li>
<li><code>cluster_processlist</code>のテーブルは、グローバルのプロセスリストの情報を保存する。</li>
<li><code>inspection_result</code>のテーブルは、システムのボトルネックを自動的に分析し、DBAがパフォーマンス分析レポートを役立ちます。障害分析の効率を向上させる。</li>
<li><code>metrics_summary</code>と<code>metric_summary_by_label</code>テーブルは、システムの全てのメトリックの情報を保存する、DBAが<code>SQL</code>を介してメトリックの読みますおよび過去のデータと比較する。</li>
<li><code>inspection_summary</code>テーブルは、複数のデータリンクとアクセスリンク中のさまざまな主要な監視メトリックを保存する。DBAが読み取り、書き込みなどのリンクの障害を分析できます。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3><a class="header" href="#文字セットと照合順序" id="文字セットと照合順序">文字セットと照合順序</a></h3>
<p><code>TiDB 4.0</code>は大文字小文字を区別しません<code>utf8mb4_general_ci</code>とアクセントを区別しない<code>utf8_general_ci，详情参阅</code>をサポートする。詳しくは<a href="https://docs.pingcap.com/tidb/stable/character-set-and-collation">文字セットと照合順序</a>をご覧ください。</p>
<h3><a class="header" href="#セキュリティ" id="セキュリティ">セキュリティ</a></h3>
<ul>
<li>
<p>クライアントとサーバー、コンポーネント間の暗号化された通信を改善し、コネクタの安全を保証する。受信と送信されたデータがアタッカーによって読み取られたり改変されたりしないように保護します。証明書ベースの認証、オンラインで証明書を更新する、<code>TLS</code>証明書の<code>CommonName</code>属性を確認してなど。</p>
</li>
<li>
<p>透過的データ暗号化(TDE)は<code>TiDB</code>の新機能です、許可されているアプリケーションにデータを自動的に復号化して。TDEはファイルに対して、ディスク書き込み前に暗号化し、メモリに読み取り前に復号化して。<code>AES128-CTR</code>、<code>AES192-CTR</code>、<code>AES256-CTR</code>の暗号化アルゴリズムおよび<code>AWS KMS</code>にキーの管理をサポートする。詳しくは<a href="https://docs.pingcap.com/tidb/stable/encryption-at-rest">保存時の暗号化</a>をご覧ください。</p>
</li>
</ul>
<h3><a class="header" href="#バックアップと復元" id="バックアップと復元">バックアップと復元</a></h3>
<p>バックアップの所要時間を短縮するテクニックは、単一の<code>TiDB</code>クラスターをバックアップと復元できます。高速の完全バックアップと復元をサポートし、データのソートして、範囲による分割をサポート。詳しくは<a href="https://docs.pingcap.com/tidb/stable/backup-and-restore-tool">バックアップと復元</a>をご覧ください。</p>
<h3><a class="header" href="#サービスレベル" id="サービスレベル">サービスレベル</a></h3>
<ul>
<li>
<p><code>Prepare/Execute</code>リクエストの実行プランのキャッシュをサポートして、<code>SQL</code>実行効率を向上させる。詳しくは<a href="https://docs.pingcap.com/tidb/stable/sql-prepare-plan-cache"><code>Prepare/Execute</code>プランのキャッシュ</a>をご覧ください。</p>
</li>
<li>
<p>新しいのレッドプールを実現します、スレッドプールの数を減らし、リクエストのスケジュールは最適化した。<code>TiDB</code>のパフォーマンスを向上させます。</p>
</li>
<li>
<p><code>Follower Read</code>は<code>Raft</code>プロトコルの完全一貫性を確保に基づ、<code>follower</code>ロールからデータを読み取ります、クラスターのスループットを改善し、<code>leader</code>ロールのロードを減らした。<code>Follower Read</code>ロードバランスのテクニック、<code>follower</code>ロールは完全一貫性を保証もできます。詳しくは<a href="https://docs.pingcap.com/tidb/stable/follower-read"><code>Follower Read</code></a>をご覧ください。</p>
</li>
</ul>
<h1><a class="header" href="#tidbメイン構造" id="tidbメイン構造">TiDBメイン構造</a></h1>
<p><code>TiDB</code>はスケーリングと高い可用性の機能であり、深く理解欲しいなら、先ずは<code>TiDB</code>のメイン構造勉強します。<code>TiDB</code>クラスターは三かつメインコンポーネントである、<code>TiDB Server</code>、<code>PD Server</code>、<code>TiKV Server</code>である。<code>TiSpark</code>は、複雑な<code>OLAP</code>のソリューションを目指した、<code>TiDB Operator</code>は簡単に<code>Kubernetes</code>にデプロイできます。</p>
<p><img src="03_main_concept/./img/tidb-architecture.png" alt="architecture" /></p>
<h2><a class="header" href="#tidb-server" id="tidb-server">TiDB Server</a></h2>
<p><code>TiDB Server</code>は<code>SQL</code>リクエストに受信します。<code>TiDB Server</code>は<code>SQL</code>を実行計画にインタプリタ後は<code>PD Server</code>にデータ保管の<code>TiKV Server</code>アドレス見つかった。<code>TiDB Server</code>を<code>TiKV Server</code>に通信データにアクセスして。<code>TiDB Server</code>は持久的データではありません、自体はストレジの機能ではない、計算のみを担当、スケーリングできます。負荷分散コンポーネント（<code>LVS</code>、<code>HAProxy</code>、<code>F5</code>）利用すれば、同じアドレスのことである。</p>
<h2><a class="header" href="#pd-server" id="pd-server">PD Server</a></h2>
<p><code>Placement Driver</code>（<code>PD</code>）は、クラスター全体の管理者、主な機能は3つであり、１つはクラスターのメタデータを保管するのこと（<code>Key</code>と<code>TiKV</code>の対応）、二つは<code>TiKV</code>クラスターのスケジューリングと負荷分散、そしてグローバルにユニークの増分のトランザクションのIDを管理配分する。</p>
<p><code>PD</code>は<code>Raft</code>の分散コヒーレンスプロトコルを使用してデータのセキュリティを保証する。<code>Raft</code>のリーダーサーバーを全ての操作を処理する、他のフォロワーサーバーは高可用性を保証するためにのみ使用されます。奇数の<code>PD</code>サーバーを展開することをお勧めします。</p>
<h2><a class="header" href="#tikv-server" id="tikv-server">TiKV Server</a></h2>
<p><code>TiKV Server</code>はデータ実際の保管場所。外部向から、<code>TiKV</code>は分散トランザクションを提供するに<code>Key-Value</code>ストレージエンジンである。データを保存するための基本単位はリージョンであり、リージョンはレンジキー（<code>StartKey</code>から<code>EndKey</code>の左閉右開リージョン）のデータを保存する、1つの<code>TiKV</code>に複数のリージョンがあります。<code>TiKV</code>は、データの耐障害性を保証するために、<code>Raft</code>プロトコルの一貫性のレプリケーションを行うことがである。レプリケーションはリージョンで管理され、複数の異なるノードはリージョンはお互いのコピーである<code>Raft</code>グループを形成します。複数の<code>TiKV</code>間のデータのロードバランスは<code>PD</code>によってスケジュールされ、これもリージョン単位でスケジュールされます。</p>
<h2><a class="header" href="#tispark" id="tispark">TiSpark</a></h2>
<p><code>TiSpark</code>は、ユーザーの複雑な<code>OLAP</code>要件を解決する<code>TiDB</code>の主要コンポーネントとして、<code>TiDB</code>クラスターに<code>Spark SQL</code>直接に実行にことはである。<code>TiSpark</code>は分散<code>TiKV</code>クラスターの利点を組み合わせ、ビッグデータエコシステムに統合します。<code>TiSpark</code>を使用すると、<code>TiDB</code>は1つのクラスターで<code>OLTP</code>と<code>OLAP</code>の両方のシナリオを対応できるため、ユーザーはデータ転送を心配する必要がありません。</p>
<h2><a class="header" href="#tidb-operator" id="tidb-operator">TiDB Operator</a></h2>
<p><code>TiDB Operator</code>は、主流のクラウドインフラストラクチャ（<code>Kubernetes</code>）でTiDBクラスターを展開、管理、マルチクラスターハイブリッド、障害の自動修復できるようにします。</p>
<h1><a class="header" href="#tidbメイン構造-1" id="tidbメイン構造-1">TiDBメイン構造</a></h1>
<p><code>TiDB</code>はスケーリングと高い可用性の機能であり、深く理解欲しいなら、先ずは<code>TiDB</code>のメイン構造勉強します。<code>TiDB</code>クラスターは三かつメインコンポーネントである、<code>TiDB Server</code>、<code>PD Server</code>、<code>TiKV Server</code>である。<code>TiSpark</code>は、複雑な<code>OLAP</code>のソリューションを目指した、<code>TiDB Operator</code>は簡単に<code>Kubernetes</code>にデプロイできます。</p>
<p><img src="03_main_concept/./img/tidb-architecture.png" alt="architecture" /></p>
<h2><a class="header" href="#tidb-server-1" id="tidb-server-1">TiDB Server</a></h2>
<p><code>TiDB Server</code>は<code>SQL</code>リクエストに受信します。<code>TiDB Server</code>は<code>SQL</code>を実行計画にインタプリタ後は<code>PD Server</code>にデータ保管の<code>TiKV Server</code>アドレス見つかった。<code>TiDB Server</code>を<code>TiKV Server</code>に通信データにアクセスして。<code>TiDB Server</code>は持久的データではありません、自体はストレジの機能ではない、計算のみを担当、スケーリングできます。負荷分散コンポーネント（<code>LVS</code>、<code>HAProxy</code>、<code>F5</code>）利用すれば、同じアドレスのことである。</p>
<h2><a class="header" href="#pd-server-1" id="pd-server-1">PD Server</a></h2>
<p><code>Placement Driver</code>（<code>PD</code>）は、クラスター全体の管理者、主な機能は3つであり、１つはクラスターのメタデータを保管するのこと（<code>Key</code>と<code>TiKV</code>の対応）、二つは<code>TiKV</code>クラスターのスケジューリングと負荷分散、そしてグローバルにユニークの増分のトランザクションのIDを管理配分する。</p>
<p><code>PD</code>は<code>Raft</code>の分散コヒーレンスプロトコルを使用してデータのセキュリティを保証する。<code>Raft</code>のリーダーサーバーを全ての操作を処理する、他のフォロワーサーバーは高可用性を保証するためにのみ使用されます。奇数の<code>PD</code>サーバーを展開することをお勧めします。</p>
<h2><a class="header" href="#tikv-server-1" id="tikv-server-1">TiKV Server</a></h2>
<p><code>TiKV Server</code>はデータ実際の保管場所。外部向から、<code>TiKV</code>は分散トランザクションを提供するに<code>Key-Value</code>ストレージエンジンである。データを保存するための基本単位はリージョンであり、リージョンはレンジキー（<code>StartKey</code>から<code>EndKey</code>の左閉右開リージョン）のデータを保存する、1つの<code>TiKV</code>に複数のリージョンがあります。<code>TiKV</code>は、データの耐障害性を保証するために、<code>Raft</code>プロトコルの一貫性のレプリケーションを行うことがである。レプリケーションはリージョンで管理され、複数の異なるノードはリージョンはお互いのコピーである<code>Raft</code>グループを形成します。複数の<code>TiKV</code>間のデータのロードバランスは<code>PD</code>によってスケジュールされ、これもリージョン単位でスケジュールされます。</p>
<h2><a class="header" href="#tispark-1" id="tispark-1">TiSpark</a></h2>
<p><code>TiSpark</code>は、ユーザーの複雑な<code>OLAP</code>要件を解決する<code>TiDB</code>の主要コンポーネントとして、<code>TiDB</code>クラスターに<code>Spark SQL</code>直接に実行にことはである。<code>TiSpark</code>は分散<code>TiKV</code>クラスターの利点を組み合わせ、ビッグデータエコシステムに統合します。<code>TiSpark</code>を使用すると、<code>TiDB</code>は1つのクラスターで<code>OLTP</code>と<code>OLAP</code>の両方のシナリオを対応できるため、ユーザーはデータ転送を心配する必要がありません。</p>
<h2><a class="header" href="#tidb-operator-1" id="tidb-operator-1">TiDB Operator</a></h2>
<p><code>TiDB Operator</code>は、主流のクラウドインフラストラクチャ（<code>Kubernetes</code>）でTiDBクラスターを展開、管理、マルチクラスターハイブリッド、障害の自動修復できるようにします。</p>
<h1><a class="header" href="#tidb-wasm-原理と実現" id="tidb-wasm-原理と実現">TiDB-Wasm 原理と実現</a></h1>
<p>クイックスタート：<a href="https://play.pingcap.com/">https://play.pingcap.com/</a></p>
<p><img src="blog/./tidb-wasm/tidb-wasm-demo.png" alt="tidb-wasm-demo" /></p>
<h2><a class="header" href="#webassembly-の概要" id="webassembly-の概要">WebAssembly の概要</a></h2>
<p>読者に<code>WebAssembly</code>大体理解ために、先ずはこの技術の基本的な紹介である。</p>
<p><code>WebAssembly</code>の<a href="https://webassembly.org/">公式紹介</a>はこちら。</p>
<p><code>WebAssembly</code>（以下略記<code>Wasm</code>）は、スタックベースの仮想マシン用のバイナリ命令形式であり、 <code>Wasm</code>は、<code>C</code>、<code>C++</code>、<code>Rust</code>などの高レベル言語のコンパイル用のポータブルターゲットとして設計されており、クライアントおよびサーバー上のアプリケーション用に<code>Web</code>上に展開できます。</p>
<p>言い換えれば、以下の結論で。</p>
<ul>
<li>
<p><code>Wasm</code>は実行ファイルです。</p>
</li>
<li>
<p><code>C</code>、<code>C++</code>、<code>Rust</code>などの高レベル言語のプログラムを<code>Wasm</code>にコンパイルできます。</p>
</li>
<li>
<p><code>Wasm</code>はブラウザに実行できます。</p>
</li>
</ul>
<h3><a class="header" href="#実行の命令形式" id="実行の命令形式">実行の命令形式</a></h3>
<p>以上の三つの結論見てとうり、質問があるかもしれます、命令形式は何ですか？一般的な<a href="https://ja.wikipedia.org/wiki/Executable_and_Linkable_Format"><code>ELFファイル</code></a>は<code>Unix</code>システムの共通の実行バイナリ命令形式、ローダーによって解析され、メモリにはいります、そして実行です。<code>Wasm</code>も同様、対応のランタイムを解析および実行である。現在、主流のブラウザー、<a href="https://nodejs.org/">Node.js</a>、および<code>Wasmer</code>と呼ばれる<code>Wasm</code>専用に設計された一般的なランタイムです。さらに一歩進む、<code>Wasm</code>作成したプログラムをカーネルモードで簡単に実行できるために、<code>Wasm</code>ランタイムをカーネルに統合する機能を<code>Linux</code>カーネルに提供する人もいます。</p>
<p>主要なブラウザの<a href="https://developer.mozilla.org/ja/docs/WebAssembly"><code>Wasm</code>サポート</a>：</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-support.png" alt="wasm-support" /></p>
<h3><a class="header" href="#高レベル言語からwasmまで" id="高レベル言語からwasmまで">高レベル言語から<code>Wasm</code>まで</a></h3>
<p>上記の背景知識があれば、高レベル言語がどのように<code>Wasm</code>にコンパイルされる方は理解できます。まず、高水準言語のコンパイルプロセスを見てください。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-compile-process.png" alt="compile-process" /></p>
<p>アセンブリと比較して、高レベル言語の特徴の1つは移植性です。例えば、<code>C</code>と<code>C++</code>は<code>x86</code>マシンのターゲットにコンパイルできます、および<code>ARM</code>のマシンのターゲット。<code>Wasm</code>と<code>ARM</code>、<code>x86</code>は実際には同じ種類のものであり、バイトコードの実行をサポートする仮想マシンと考えることができます。これは<code>Java</code>に非常に似ていますが、実際には、<code>C</code>と<code>C++</code>は<code>JVM</code>にコンパイルおよび実行できます。</p>
<h3><a class="header" href="#さまざまなランタイムとwasi" id="さまざまなランタイムとwasi">さまざまなランタイムと<code>WASI</code></a></h3>
<p>以上は<code>Wasm</code>のデザインの目標はプログラムに<code>web</code>上に実行です。実際、<code>Wasm</code>の元々デザインのターゲットは<code>JavaScript</code>の実行効率を補うためください。開発が進むにつれて、この技術は仮想マシンとして扱う、そしてプログラムに移植するはまた、良いアイデアである。そのため、<code>NodeJS</code>の実行環境、<code>Wasmer</code>の実行環境、さらにはカーネル環境もあります。それから質問が来ます、こんあ沢山の実行環境であり、しかも各環境のインターフェースは違います、例えば、<code>NodeJS</code>はファイルシステムのインターフェースはできます、ブラウザはこのインターフェースはできまさん。<code>Wasm</code>の移植性に対処するには、<a href="https://github.com/WebAssembly/WASI"><code>WASI(WebAssembly System Interface)</code></a>が生まれました。<code>WASI</code>は低レベルの標準のインターフェースを定義します、コンパイラとWasmランタイム環境がこの標準をサポートしている限り、生成された<code>Wasm</code>はさまざまな環境にに移植できます。<code>Wasm</code>ランタイムは仮想マシンに相当し、<code>Wasm</code>はこのマシンの実行可能プログラムであり、<code>WASI</code>はこのマシンで実行されているシステムであり、そして<code>Wasm</code>の基礎的なインターフェースを提供します、例えばファイルシステムおよびソケットなど。</p>
<p><code>Wasm</code>と<code>WASI</code>が何であるかをより良く説明するために、Hello Worldを使用して説明します、<a href="https://talks.godoc.org/github.com/chai2010/awesome-go-zh/chai2010/chai2010-golang-wasm.slide#27">デモソース</a>。</p>
<pre><code class="language-lisp">(module
    ;; type iov struct { iov_base, iov_len int32 }
    ;; func fd_write(id *iov, iovs_len int32, nwritten *int32) (written int32)
    (import &quot;wasi_unstable&quot; &quot;fd_write&quot; (func $fd_write (param i32 i32 i32 i32) (result i32)))

    (memory 1)(export &quot;memory&quot; (memory 0))

    ;; The first 8 bytes are reserved for the iov array, starting with address 8
    (data (i32.const 8) &quot;hello world\n&quot;)

    ;; _start is similar to main function, will be executed automatically
    (func $main (export &quot;_start&quot;)
        (i32.store (i32.const 0) (i32.const 8))  ;; iov.iov_base - The string address is 8
        (i32.store (i32.const 4) (i32.const 12)) ;; iov.iov_len  - String length

        (call $fd_write
            (i32.const 1)  ;; 1 is stdout
            (i32.const 0)  ;; *iovs - The first 8 bytes are reserved for the iov array
            (i32.const 1)  ;; len(iovs) - Only 1 string
            (i32.const 20) ;; nwritten - Pointer, inside is the length of the data to be written
        )
        drop ;; Ignore return value
    )
)
</code></pre>
<p>特定の命令の説明は、<a href="https://pengowray.github.io/wasm-ops/">命令セット</a>を参照できます。</p>
<p>こちらの<code>hello.wat</code>は<code>Wasm</code>のテキストコードです、<code>wat</code>と<code>Wasm</code>の関係は、アセンブリと<code>ELF</code>の関係に似ています。次に、<code>wat</code>を<code>Wasm</code>にコンパイルし、<code>Wasmer</code>（一般的な<code>Wasm</code>ランタイム実装）を使用して実行します。</p>
<p>先ずは依存関係をインストールする。</p>
<ul>
<li>
<p><a href="https://github.com/wasmerio/wasmer">Wasmer</a></p>
</li>
<li>
<p><a href="https://github.com/WebAssembly/wabt">wabt</a></p>
</li>
</ul>
<p>そしてコンパイルおよび実行。</p>
<pre><code class="language-sh">~ » wat2wasm hello.wat -o hello.wasm
~ » wasmer run hello.wasm
hello world
</code></pre>
<h2><a class="header" href="#tidb-の改修" id="tidb-の改修">TiDB の改修</a></h2>
<p>未知は恐怖の源です、<code>Wasm</code>の原理を知っているなら、<code>TiDB</code>をブラウザに移動できます。</p>
<h3><a class="header" href="#ブラウザのセキュリティポリシー" id="ブラウザのセキュリティポリシー">ブラウザのセキュリティポリシー</a></h3>
<p>よく知られている、ブラウザは本質的にサンドボックスです、内部のプログラムは危険のアクションは許可されていません、例えばポートをリスニングおよびファイルシステム。しかし、<code>TiDB</code>は使用の方がポートをリスニング、そしてユーザーは<code>MySQL</code>クライアントを使用して接続できます。そのために、<code>TiDB</code>はポートのをリスニングは必要であり。少し考えて、ポートをリスニングの限界突破、そして<code>MySQL</code>クライアントを使用して接続のことはいいじゃないは理解するできます。理想的な方法は<code>MySQL</code>クライアントのターミナルがウェブページの中にある、そしてこのクライアントは<code>TiDB</code>は接続されています。</p>
<p>先ずは、<code>TiDB</code>はターミナルを統合するのことは考えて。ユーザー入力<code>SQL</code>を受け入れ、そして出力は<code>SQL</code>の実行結果です。この<code>TiDB</code>のエグゼクティブターミナルを実装するのは難しい、ショートカットを考えました、<code>TiDB</code>のテストコードを使用してターミナルを後付けすることを計画。これはテストコードで見つかったスニペットです。</p>
<pre><code class="language-go">result = tk.MustQuery(&quot;select count(*) from t group by d order by c&quot;)
result.Check(testkit.Rows(&quot;3&quot;, &quot;2&quot;, &quot;2&quot;))
</code></pre>
<p><code>tk</code>という名前のこのオブジェクトは、<code>SQL</code>ターミナルとして使用できます。これは<code>tk</code>の主な関数。</p>
<pre><code class="language-go">// Exec executes a sql statement.
func (tk *TestKit) Exec(sql string, args ...interface{}) (sqlexec.RecordSet, error) {
	var err error
	if tk.Se == nil {
		tk.Se, err = session.CreateSession4Test(tk.store)
		tk.c.Assert(err, check.IsNil)
		id := atomic.AddUint64(&amp;connectionID, 1)
		tk.Se.SetConnectionID(id)
	}
	ctx := context.Background()
	if len(args) == 0 {
		var rss []sqlexec.RecordSet
		rss, err = tk.Se.Execute(ctx, sql)
		if err == nil &amp;&amp; len(rss) &gt; 0 {
			return rss[0], nil
		}
		return nil, errors.Trace(err)
	}
	stmtID, _, _, err := tk.Se.PrepareStmt(sql)
	if err != nil {
		return nil, errors.Trace(err)
	}
	params := make([]types.Datum, len(args))
	for i := 0; i &lt; len(params); i++ {
		params[i] = types.NewDatum(args[i])
	}
	rs, err := tk.Se.ExecutePreparedStmt(ctx, stmtID, params)
	if err != nil {
		return nil, errors.Trace(err)
	}
	err = tk.Se.DropPreparedStmt(stmtID)
	if err != nil {
		return nil, errors.Trace(err)
	}
	return rs, nil
}
</code></pre>
<p>後では簡単です、Read-Eval-Print-Loop（REPL）プログラムを作成してユーザー入力を読み取り、入力を上記の<code>Exec</code>関数に渡し、<code>Exec</code>関数の出力を標準出力にフォーマットしてから、ループでユーザー入力の読み取りを続けます。</p>
<h3><a class="header" href="#コンパイルの問題" id="コンパイルの問題">コンパイルの問題</a></h3>
<p>ターミナルの統合は最初の手順です、次には重要な質問を検証する必要があります。<code>TiDB</code>を<code>Wasm</code>のターゲットにコンパイルできますか？<code>TiDB</code>は<code>Golang</code>で製されていますが、しかし、参照されたライブラリは、プラットフォーム固有のコードを直接コンパイルできない場合があります。<a href="https://github.com/golang/go/wiki/WebAssembly#getting-started">公式の<code>Golang</code>ドキュメント</a>に従ってコンパイルはできません。</p>
<pre><code class="language-sh">~/go/src/github.com/pingcap/tidb(master*) » GOOS=js GOARCH=wasm go build -o bin/tidb.wasm tidb-server/main.go
build command-line-arguments: cannot load github.com/pingcap/tidb/util/signal: no Go source files

~/go/src/github.com/pingcap/tidb(master*) » ls util/signal
signal_posix.go  signal_windows.go
</code></pre>
<p><code>signal</code>関連の関数に<code>Wasm</code>プラットフォームの実装がないため、コンパイルに失敗しました。ネコをマネてトラを描くのことのように、<code>signal wasm.go</code>を実装する。</p>
<pre><code class="language-go">package signal

// SetupSignalHandler setup signal handler for TiDB Server
func SetupSignalHandler(shutdownFunc func(bool)) {
}
</code></pre>
<p>そして、コンパイルを再開する。</p>
<pre><code class="language-sh">~/go/src/github.com/pingcap/tidb(master*) » GOOS=js GOARCH=wasm go build -o bin/tidb.wasm tidb-server/main.go
# github.com/coreos/go-systemd/journal
../../../../pkg/mod/github.com/coreos/go-systemd@v0.0.0-20181031085051-9002847aa142/journal/journal.go:99:13: undefined: syscall.UnixRights
# github.com/pingcap/goleveldb/leveldb/storage
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:81:16: undefined: newFileLock
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:166:3: undefined: rename
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:252:11: undefined: rename
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:257:11: undefined: syncDir
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:354:14: undefined: rename
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:483:9: undefined: rename
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:519:13: undefined: syncDir
# github.com/remyoudompheng/bigfft
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:10:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:11:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:12:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:13:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:14:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:15:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:16:6: missing function body
</code></pre>
<p>これは同じ問題だ、偽物の実装を使用する、コンパイルは可能です。</p>
<pre><code class="language-go">package storage

import (
	&quot;os&quot;
	&quot;syscall&quot;
)

func newFileLock(path string, readOnly bool) (fl fileLock, err error) {
	return nil, syscall.ENOTSUP
}

func setFileLock(f *os.File, readOnly, lock bool) error {
	return syscall.ENOTSUP
}

func rename(oldpath, newpath string) error {
	return syscall.ENOTSUP
}

func isErrInvalid(err error) bool {
	return false
}

func syncDir(name string) error {
	return syscall.ENOTSUP
}
</code></pre>
<p>同じ方法を使用して<code>arith_decl</code>の問題を解決はできません、<code>missing function body</code>エラーとは何ですか？<code>arith_decl.go</code>のディレクトリは見てとうり、何が起こったのかがわかります。</p>
<pre><code class="language-sh">~ » ls ~/go/pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7
arith_386.s    arith_arm64.s  arith_decl.go    arith_mipsx.s  calibrate_test.go  fermat_test.go  fft_test.go  LICENSE  scan.go
arith_amd64.s  arith_arm.s    arith_mips64x.s  benchmarks     fermat.go          fft.go          go.mod       README   scan_test.go
</code></pre>
<p><code>arith_decl.go</code>は関数の宣言であり、関数の特定の実装は、各プラットフォームに関連するなアセンブリファイルにあります。</p>
<p>対応の関数は実装、問題は解除できる、そう考えるのは簡単すぎる。この<code>bigfft</code>はライブラリです、だからそちのコードの編集は簡単な作業ではありません。<code>TiDB</code>はこのライブラリに直接依存せず、代わりに<code>mathutil</code>に依存し、<code>mathutil</code>lはこの<code>bigfft</code>に依存します。</p>
<p><code>TiDB</code>は、<code>mathutil</code>のライブラリが提供する関数を使用します、理想的な対策はデフォルトでこれら2つのライブラリを使用する、<code>Wasm</code>のコンパイル時には使用されません。そのために、<code>util/mathutil</code>パッケージを作成する、中にリ<code>mathutil_linux.go</code>と<code>mathutil_js.go</code>を入れて。元々参照されていた関数を<code>mathutil_linux.go</code>に再輸出します、これらの関数は<code>mathutil_js.go</code>に再実装されます。これから、<code>Wasm</code>のターゲットをコンパイルの時はオリジナルの<code>mathutil</code>ライブラリを使用しません。</p>
<pre><code class="language-sh">~/go/src/github.com/pingcap/tidb(feature/wasm) » GOOS=js GOARCH=wasm go build -o bin/tidb.wasm tidb-server/main.go
~/go/src/github.com/pingcap/tidb(feature/wasm) » ls -l bin
total 85816
-rwxrwxr-x 1 coder coder 87868180 Dec 14 18:16 tidb.wasm
</code></pre>
<p>成功しました！</p>
<h3><a class="header" href="#互換性の問題" id="互換性の問題">互換性の問題</a></h3>
<p>コンパイル出したの<code>tidb.wasm</code>は<code>os.Stdin</code>を介して入力した<code>SQL</code>を読み取り、<code>os.Stdout</code>を介して結果を出力します。だから、ウェブページはまだブランクした。ただし、<code>TiDB</code>のログは<code>os.Stdout</code>に送られるため、ブラウザコンソールで<code>TiDB</code>の通常の起動のログを確認する必要があります。しかし、残念ながら例外のスタックトレースが表示されます。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-exception-stack.png" alt="exception-stack" /></p>
<p>このエラーが発生するの理由は<code>os.Stat</code>は実装しない。現在、<code>Golang</code>は<code>WASI</code>のサポートはあまり良くない、<code>wasm_exec.js</code>で<code>fs</code>を部分的に実装しています：</p>
<pre><code class="language-js">global.fs = {
  writeSync(fd, buf) {
    ...
  },
  write(fd, buf, offset, length, position, callback) {
    ...
  },
  open(path, flags, mode, callback) {
    ...
  },
  ...
}
</code></pre>
<p>この<code>fs</code>の実装は<code>stat</code>、<code>lstat</code>、<code>unlink</code>、<code>mkdir</code>などの呼び出しを実装しません。幸いなことに、<code>JavaScript</code>は動的プログラミング言語です、関数を<code>fs</code>に動的に追加できます。</p>
<pre><code class="language-js">function unimplemented() {
  const err = new Error('not implemented');
  err.code = 'ENOSYS';
  arguments[arguments.length - 1](err)
}

fs.stat = unimplemented;
fs.lstat = unimplemented;
fs.unlink = unimplemented;
fs.rmdir = unimplemented;
fs.mkdir = unimplemented;
go.run(result.instance);
</code></pre>
<p>ウェブページを再読み込み、起動ログがコンソールに表示されました！</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-startup-log.png" alt="startup-log" /></p>
<p>これまで、<code>TiDB</code>を<code>Wasm</code>にコンパイルするの技術的な問題はすべて解決されました。後では、以前に作成されたの<code>REPL</code>ターミナルを置き換える適切なターミナルを見つけることなら、ページに<code>SQL</code>を入力してのことはできます。</p>
<h3><a class="header" href="#ユーザーインターフェース" id="ユーザーインターフェース">ユーザーインターフェース</a></h3>
<p>上記の仕事により、<code>SQL</code>を受け入れてその実行結果を出力する<code>Exec</code>関数ができました。ブラウザで実行するには、この関数とインタラクションするためのブラウザバージョンの<code>SQL</code>ターミナルも必要です。その対策は<code>window</code>に<code>Exec</code>関数を登録する、なら<code>JavaScript</code>の関数は<code>Exec</code>呼び出すことはできます。</p>
<pre><code class="language-go">js.Global().Set(&quot;executeSQL&quot;, js.FuncOf(func(this js.Value, args []js.Value) interface{} {
	go func() {
		// Simplified code
		sql := args[0].String()
		args[1].Invoke(k.Exec(sql))
	}()
	return nil
}))
</code></pre>
<p>それで、コンソールの場合は<code>SQL</code>を実行できます。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-console-call-go-func.png" alt="console-call-go-func" /></p>
<p><code>jquery.console.js</code>を使用して<code>SQL</code>ターミナルを構築し、<code>executeSQL</code>をコールバックとして渡します。完了します！</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-show-databases.png" alt="show-databases" /></p>
<h3><a class="header" href="#ローカルファイルアクセス" id="ローカルファイルアクセス">ローカルファイルアクセス</a></h3>
<p><code>TiDB</code>には、ローカルファイルシステムにアクセスする必要があるいくつかの関数があります、例えば<a href="https://pingcap.com/docs/stable/reference/sql/statements/load-data/"><code>LOAD DATA</code></a>および<code>LOAD STATS</code>。<code>LOAD DATA</code>の機能は、ローカルファイルからデータベースにデータをインポートする。交換方法はブラウザのファイルアップロードウィンドウを使用した、<code>LOAD STATS</code>の実装は同じです。</p>
<pre><code class="language-go">js.Global().Get(&quot;upload&quot;).Invoke(js.FuncOf(func(this js.Value, args []js.Value) interface{} {
go func() {
	fileContent := args[0].String()
		_, e := doSomething(fileContent)
			c &lt;- e
	}()
	return nil
}), js.FuncOf(func(this js.Value, args []js.Value) interface{} {
	go func() {
		c &lt;- errors.New(args[0].String())
	}()
	return nil
}))
</code></pre>
<p><code>SOURCE</code>コマンドはローカルファイルを読み取り、まとは<code>MySQL</code>クライアントで実行します。<code>TiDB</code>を初めて使用するユーザーは、<code>TiDB</code>と<code>MySQL</code>の互換性を確認したいと考えています。このコマンドは、ユーザーがテストデータをすば速いインポートするのに役立ちます。</p>
<p><code>SOURCE</code>コマンドの効果を示す例として<code>test.sql</code>ファイルを取り上げます<code>test.sql</code>ファイルの内容は下記です。</p>
<pre><code class="language-sql">CREATE DATABASE IF NOT EXISTS samp_db;

USE samp_db;

CREATE TABLE IF NOT EXISTS person (
  number INT(11),
  name VARCHAR(255),
  birthday DATE
);

CREATE INDEX person_num ON person (number);

INSERT INTO person VALUES(&quot;1&quot;,&quot;tom&quot;,&quot;20170912&quot;);

UPDATE person SET birthday='20171010' WHERE name='tom';
</code></pre>
<p><code>SOURCE</code>コマンドを入力すると、ファイル選択ボックスがポップアップします。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-source-file-select.png" alt="source-file-select" /></p>
<p>選択後、<code>SQL</code>が自動的に実行され、<code>TiDB</code>のテストを続行できます。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-source-test.png" alt="source-test" /></p>
<h2><a class="header" href="#まとめと展望" id="まとめと展望">まとめと展望</a></h2>
<p>TiDBを移植するために、主にいくつかの問題を解決しました。</p>
<ul>
<li>
<p>ブラウザはポートをリスニングのことはできません。<code>SQL</code>ターミナルを<code>TiDB</code>に埋め込みました。</p>
</li>
<li>
<p><code>goleveldb</code>の<code>Wasm</code>コンパイル。</p>
</li>
<li>
<p><code>bigfft</code>の<code>Wasm</code>コンパイル。</p>
</li>
<li>
<p><code>Golang</code>は<code>WASI</code>のサポートが不完全なため、<code>fs</code>関連の機能がありません。</p>
</li>
<li>
<p><code>TiDB</code>はローカルファイルの読み込みをブラウザのアップロードファイルの読み込みに変換します。</p>
</li>
<li>
<p><code>SQL</code>をバッチで実行する<code>SOURCE</code>コマンドをサポート。</p>
</li>
</ul>
<p>現在<code>PingCAP</code>は、このプロジェクトを<a href="https://play.pingcap.com/">TiDB Playground</a>および<a href="https://tour.pingcap.com/">TiDB Tour</a>のユーザーが利用できるようにしました。ユーザーはインストールと構成を行う必要がないため、ユーザーはドキュメントを読みながら試してみることができます。これにより、ユーザーが<code>TiDB</code>は使用して学ぶ安いです。コミュニティにはすでに<code>TiDB Wasm</code>に基づくデータベースチュートリアルがあります<a href="https://github.com/imiskolee/tidb-wasm-markdown">tidb-wasm-markdown</a>。</p>
<p>このプロジェクトは<code>PingCAP Hackathon</code>で二等賞を受賞しました。スケジュールが厳しいため、まだたくさんの機能は実装されていません、例えば：</p>
<ul>
<li>
<p><code>IndexedDB</code>を使用したデータの永続化：<code>IndexedDB</code>のストレージインターフェイスのセットを実装する。</p>
</li>
<li>
<p><code>P2P</code>を使用した他のブラウザーにサービスを提供する：将来、ますます多くのアプリケーションが<code>Wasm</code>に移行されるでしょう、多くのデータベースが必要、<code>TiDB Wasm</code>を使用できます。</p>
</li>
<li>
<p><code>TiDB Wasm</code>のバイナリスリミング：現在のはほぼ<code>80MB</code>、読み込みが遅い、実行時によりたくさんのメモリを使用する、これらは最適化する必要があります。</p>
</li>
</ul>
<p>興味のあるコミュニティの友人は、このプロジェクトに参加して一緒に楽しんでください、<a href="https://github.com/pingcap/tidb/projects/27">プロジェクト</a>、<a href="mailto:info@pingcap.com">info@pingcap.com</a>でお問い合わせいただくこともできます。</p>
<h1><a class="header" href="#tidb-wasm-原理と実現-1" id="tidb-wasm-原理と実現-1">TiDB-Wasm 原理と実現</a></h1>
<p>クイックスタート：<a href="https://play.pingcap.com/">https://play.pingcap.com/</a></p>
<p><img src="blog/./tidb-wasm/tidb-wasm-demo.png" alt="tidb-wasm-demo" /></p>
<h2><a class="header" href="#webassembly-の概要-1" id="webassembly-の概要-1">WebAssembly の概要</a></h2>
<p>読者に<code>WebAssembly</code>大体理解ために、先ずはこの技術の基本的な紹介である。</p>
<p><code>WebAssembly</code>の<a href="https://webassembly.org/">公式紹介</a>はこちら。</p>
<p><code>WebAssembly</code>（以下略記<code>Wasm</code>）は、スタックベースの仮想マシン用のバイナリ命令形式であり、 <code>Wasm</code>は、<code>C</code>、<code>C++</code>、<code>Rust</code>などの高レベル言語のコンパイル用のポータブルターゲットとして設計されており、クライアントおよびサーバー上のアプリケーション用に<code>Web</code>上に展開できます。</p>
<p>言い換えれば、以下の結論で。</p>
<ul>
<li>
<p><code>Wasm</code>は実行ファイルです。</p>
</li>
<li>
<p><code>C</code>、<code>C++</code>、<code>Rust</code>などの高レベル言語のプログラムを<code>Wasm</code>にコンパイルできます。</p>
</li>
<li>
<p><code>Wasm</code>はブラウザに実行できます。</p>
</li>
</ul>
<h3><a class="header" href="#実行の命令形式-1" id="実行の命令形式-1">実行の命令形式</a></h3>
<p>以上の三つの結論見てとうり、質問があるかもしれます、命令形式は何ですか？一般的な<a href="https://ja.wikipedia.org/wiki/Executable_and_Linkable_Format"><code>ELFファイル</code></a>は<code>Unix</code>システムの共通の実行バイナリ命令形式、ローダーによって解析され、メモリにはいります、そして実行です。<code>Wasm</code>も同様、対応のランタイムを解析および実行である。現在、主流のブラウザー、<a href="https://nodejs.org/">Node.js</a>、および<code>Wasmer</code>と呼ばれる<code>Wasm</code>専用に設計された一般的なランタイムです。さらに一歩進む、<code>Wasm</code>作成したプログラムをカーネルモードで簡単に実行できるために、<code>Wasm</code>ランタイムをカーネルに統合する機能を<code>Linux</code>カーネルに提供する人もいます。</p>
<p>主要なブラウザの<a href="https://developer.mozilla.org/ja/docs/WebAssembly"><code>Wasm</code>サポート</a>：</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-support.png" alt="wasm-support" /></p>
<h3><a class="header" href="#高レベル言語からwasmまで-1" id="高レベル言語からwasmまで-1">高レベル言語から<code>Wasm</code>まで</a></h3>
<p>上記の背景知識があれば、高レベル言語がどのように<code>Wasm</code>にコンパイルされる方は理解できます。まず、高水準言語のコンパイルプロセスを見てください。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-compile-process.png" alt="compile-process" /></p>
<p>アセンブリと比較して、高レベル言語の特徴の1つは移植性です。例えば、<code>C</code>と<code>C++</code>は<code>x86</code>マシンのターゲットにコンパイルできます、および<code>ARM</code>のマシンのターゲット。<code>Wasm</code>と<code>ARM</code>、<code>x86</code>は実際には同じ種類のものであり、バイトコードの実行をサポートする仮想マシンと考えることができます。これは<code>Java</code>に非常に似ていますが、実際には、<code>C</code>と<code>C++</code>は<code>JVM</code>にコンパイルおよび実行できます。</p>
<h3><a class="header" href="#さまざまなランタイムとwasi-1" id="さまざまなランタイムとwasi-1">さまざまなランタイムと<code>WASI</code></a></h3>
<p>以上は<code>Wasm</code>のデザインの目標はプログラムに<code>web</code>上に実行です。実際、<code>Wasm</code>の元々デザインのターゲットは<code>JavaScript</code>の実行効率を補うためください。開発が進むにつれて、この技術は仮想マシンとして扱う、そしてプログラムに移植するはまた、良いアイデアである。そのため、<code>NodeJS</code>の実行環境、<code>Wasmer</code>の実行環境、さらにはカーネル環境もあります。それから質問が来ます、こんあ沢山の実行環境であり、しかも各環境のインターフェースは違います、例えば、<code>NodeJS</code>はファイルシステムのインターフェースはできます、ブラウザはこのインターフェースはできまさん。<code>Wasm</code>の移植性に対処するには、<a href="https://github.com/WebAssembly/WASI"><code>WASI(WebAssembly System Interface)</code></a>が生まれました。<code>WASI</code>は低レベルの標準のインターフェースを定義します、コンパイラとWasmランタイム環境がこの標準をサポートしている限り、生成された<code>Wasm</code>はさまざまな環境にに移植できます。<code>Wasm</code>ランタイムは仮想マシンに相当し、<code>Wasm</code>はこのマシンの実行可能プログラムであり、<code>WASI</code>はこのマシンで実行されているシステムであり、そして<code>Wasm</code>の基礎的なインターフェースを提供します、例えばファイルシステムおよびソケットなど。</p>
<p><code>Wasm</code>と<code>WASI</code>が何であるかをより良く説明するために、Hello Worldを使用して説明します、<a href="https://talks.godoc.org/github.com/chai2010/awesome-go-zh/chai2010/chai2010-golang-wasm.slide#27">デモソース</a>。</p>
<pre><code class="language-lisp">(module
    ;; type iov struct { iov_base, iov_len int32 }
    ;; func fd_write(id *iov, iovs_len int32, nwritten *int32) (written int32)
    (import &quot;wasi_unstable&quot; &quot;fd_write&quot; (func $fd_write (param i32 i32 i32 i32) (result i32)))

    (memory 1)(export &quot;memory&quot; (memory 0))

    ;; The first 8 bytes are reserved for the iov array, starting with address 8
    (data (i32.const 8) &quot;hello world\n&quot;)

    ;; _start is similar to main function, will be executed automatically
    (func $main (export &quot;_start&quot;)
        (i32.store (i32.const 0) (i32.const 8))  ;; iov.iov_base - The string address is 8
        (i32.store (i32.const 4) (i32.const 12)) ;; iov.iov_len  - String length

        (call $fd_write
            (i32.const 1)  ;; 1 is stdout
            (i32.const 0)  ;; *iovs - The first 8 bytes are reserved for the iov array
            (i32.const 1)  ;; len(iovs) - Only 1 string
            (i32.const 20) ;; nwritten - Pointer, inside is the length of the data to be written
        )
        drop ;; Ignore return value
    )
)
</code></pre>
<p>特定の命令の説明は、<a href="https://pengowray.github.io/wasm-ops/">命令セット</a>を参照できます。</p>
<p>こちらの<code>hello.wat</code>は<code>Wasm</code>のテキストコードです、<code>wat</code>と<code>Wasm</code>の関係は、アセンブリと<code>ELF</code>の関係に似ています。次に、<code>wat</code>を<code>Wasm</code>にコンパイルし、<code>Wasmer</code>（一般的な<code>Wasm</code>ランタイム実装）を使用して実行します。</p>
<p>先ずは依存関係をインストールする。</p>
<ul>
<li>
<p><a href="https://github.com/wasmerio/wasmer">Wasmer</a></p>
</li>
<li>
<p><a href="https://github.com/WebAssembly/wabt">wabt</a></p>
</li>
</ul>
<p>そしてコンパイルおよび実行。</p>
<pre><code class="language-sh">~ » wat2wasm hello.wat -o hello.wasm
~ » wasmer run hello.wasm
hello world
</code></pre>
<h2><a class="header" href="#tidb-の改修-1" id="tidb-の改修-1">TiDB の改修</a></h2>
<p>未知は恐怖の源です、<code>Wasm</code>の原理を知っているなら、<code>TiDB</code>をブラウザに移動できます。</p>
<h3><a class="header" href="#ブラウザのセキュリティポリシー-1" id="ブラウザのセキュリティポリシー-1">ブラウザのセキュリティポリシー</a></h3>
<p>よく知られている、ブラウザは本質的にサンドボックスです、内部のプログラムは危険のアクションは許可されていません、例えばポートをリスニングおよびファイルシステム。しかし、<code>TiDB</code>は使用の方がポートをリスニング、そしてユーザーは<code>MySQL</code>クライアントを使用して接続できます。そのために、<code>TiDB</code>はポートのをリスニングは必要であり。少し考えて、ポートをリスニングの限界突破、そして<code>MySQL</code>クライアントを使用して接続のことはいいじゃないは理解するできます。理想的な方法は<code>MySQL</code>クライアントのターミナルがウェブページの中にある、そしてこのクライアントは<code>TiDB</code>は接続されています。</p>
<p>先ずは、<code>TiDB</code>はターミナルを統合するのことは考えて。ユーザー入力<code>SQL</code>を受け入れ、そして出力は<code>SQL</code>の実行結果です。この<code>TiDB</code>のエグゼクティブターミナルを実装するのは難しい、ショートカットを考えました、<code>TiDB</code>のテストコードを使用してターミナルを後付けすることを計画。これはテストコードで見つかったスニペットです。</p>
<pre><code class="language-go">result = tk.MustQuery(&quot;select count(*) from t group by d order by c&quot;)
result.Check(testkit.Rows(&quot;3&quot;, &quot;2&quot;, &quot;2&quot;))
</code></pre>
<p><code>tk</code>という名前のこのオブジェクトは、<code>SQL</code>ターミナルとして使用できます。これは<code>tk</code>の主な関数。</p>
<pre><code class="language-go">// Exec executes a sql statement.
func (tk *TestKit) Exec(sql string, args ...interface{}) (sqlexec.RecordSet, error) {
	var err error
	if tk.Se == nil {
		tk.Se, err = session.CreateSession4Test(tk.store)
		tk.c.Assert(err, check.IsNil)
		id := atomic.AddUint64(&amp;connectionID, 1)
		tk.Se.SetConnectionID(id)
	}
	ctx := context.Background()
	if len(args) == 0 {
		var rss []sqlexec.RecordSet
		rss, err = tk.Se.Execute(ctx, sql)
		if err == nil &amp;&amp; len(rss) &gt; 0 {
			return rss[0], nil
		}
		return nil, errors.Trace(err)
	}
	stmtID, _, _, err := tk.Se.PrepareStmt(sql)
	if err != nil {
		return nil, errors.Trace(err)
	}
	params := make([]types.Datum, len(args))
	for i := 0; i &lt; len(params); i++ {
		params[i] = types.NewDatum(args[i])
	}
	rs, err := tk.Se.ExecutePreparedStmt(ctx, stmtID, params)
	if err != nil {
		return nil, errors.Trace(err)
	}
	err = tk.Se.DropPreparedStmt(stmtID)
	if err != nil {
		return nil, errors.Trace(err)
	}
	return rs, nil
}
</code></pre>
<p>後では簡単です、Read-Eval-Print-Loop（REPL）プログラムを作成してユーザー入力を読み取り、入力を上記の<code>Exec</code>関数に渡し、<code>Exec</code>関数の出力を標準出力にフォーマットしてから、ループでユーザー入力の読み取りを続けます。</p>
<h3><a class="header" href="#コンパイルの問題-1" id="コンパイルの問題-1">コンパイルの問題</a></h3>
<p>ターミナルの統合は最初の手順です、次には重要な質問を検証する必要があります。<code>TiDB</code>を<code>Wasm</code>のターゲットにコンパイルできますか？<code>TiDB</code>は<code>Golang</code>で製されていますが、しかし、参照されたライブラリは、プラットフォーム固有のコードを直接コンパイルできない場合があります。<a href="https://github.com/golang/go/wiki/WebAssembly#getting-started">公式の<code>Golang</code>ドキュメント</a>に従ってコンパイルはできません。</p>
<pre><code class="language-sh">~/go/src/github.com/pingcap/tidb(master*) » GOOS=js GOARCH=wasm go build -o bin/tidb.wasm tidb-server/main.go
build command-line-arguments: cannot load github.com/pingcap/tidb/util/signal: no Go source files

~/go/src/github.com/pingcap/tidb(master*) » ls util/signal
signal_posix.go  signal_windows.go
</code></pre>
<p><code>signal</code>関連の関数に<code>Wasm</code>プラットフォームの実装がないため、コンパイルに失敗しました。ネコをマネてトラを描くのことのように、<code>signal wasm.go</code>を実装する。</p>
<pre><code class="language-go">package signal

// SetupSignalHandler setup signal handler for TiDB Server
func SetupSignalHandler(shutdownFunc func(bool)) {
}
</code></pre>
<p>そして、コンパイルを再開する。</p>
<pre><code class="language-sh">~/go/src/github.com/pingcap/tidb(master*) » GOOS=js GOARCH=wasm go build -o bin/tidb.wasm tidb-server/main.go
# github.com/coreos/go-systemd/journal
../../../../pkg/mod/github.com/coreos/go-systemd@v0.0.0-20181031085051-9002847aa142/journal/journal.go:99:13: undefined: syscall.UnixRights
# github.com/pingcap/goleveldb/leveldb/storage
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:81:16: undefined: newFileLock
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:166:3: undefined: rename
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:252:11: undefined: rename
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:257:11: undefined: syncDir
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:354:14: undefined: rename
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:483:9: undefined: rename
../../../../pkg/mod/github.com/pingcap/goleveldb@v0.0.0-20171020122428-b9ff6c35079e/leveldb/storage/file_storage.go:519:13: undefined: syncDir
# github.com/remyoudompheng/bigfft
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:10:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:11:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:12:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:13:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:14:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:15:6: missing function body
../../../../pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7/arith_decl.go:16:6: missing function body
</code></pre>
<p>これは同じ問題だ、偽物の実装を使用する、コンパイルは可能です。</p>
<pre><code class="language-go">package storage

import (
	&quot;os&quot;
	&quot;syscall&quot;
)

func newFileLock(path string, readOnly bool) (fl fileLock, err error) {
	return nil, syscall.ENOTSUP
}

func setFileLock(f *os.File, readOnly, lock bool) error {
	return syscall.ENOTSUP
}

func rename(oldpath, newpath string) error {
	return syscall.ENOTSUP
}

func isErrInvalid(err error) bool {
	return false
}

func syncDir(name string) error {
	return syscall.ENOTSUP
}
</code></pre>
<p>同じ方法を使用して<code>arith_decl</code>の問題を解決はできません、<code>missing function body</code>エラーとは何ですか？<code>arith_decl.go</code>のディレクトリは見てとうり、何が起こったのかがわかります。</p>
<pre><code class="language-sh">~ » ls ~/go/pkg/mod/github.com/remyoudompheng/bigfft@v0.0.0-20190512091148-babf20351dd7
arith_386.s    arith_arm64.s  arith_decl.go    arith_mipsx.s  calibrate_test.go  fermat_test.go  fft_test.go  LICENSE  scan.go
arith_amd64.s  arith_arm.s    arith_mips64x.s  benchmarks     fermat.go          fft.go          go.mod       README   scan_test.go
</code></pre>
<p><code>arith_decl.go</code>は関数の宣言であり、関数の特定の実装は、各プラットフォームに関連するなアセンブリファイルにあります。</p>
<p>対応の関数は実装、問題は解除できる、そう考えるのは簡単すぎる。この<code>bigfft</code>はライブラリです、だからそちのコードの編集は簡単な作業ではありません。<code>TiDB</code>はこのライブラリに直接依存せず、代わりに<code>mathutil</code>に依存し、<code>mathutil</code>lはこの<code>bigfft</code>に依存します。</p>
<p><code>TiDB</code>は、<code>mathutil</code>のライブラリが提供する関数を使用します、理想的な対策はデフォルトでこれら2つのライブラリを使用する、<code>Wasm</code>のコンパイル時には使用されません。そのために、<code>util/mathutil</code>パッケージを作成する、中にリ<code>mathutil_linux.go</code>と<code>mathutil_js.go</code>を入れて。元々参照されていた関数を<code>mathutil_linux.go</code>に再輸出します、これらの関数は<code>mathutil_js.go</code>に再実装されます。これから、<code>Wasm</code>のターゲットをコンパイルの時はオリジナルの<code>mathutil</code>ライブラリを使用しません。</p>
<pre><code class="language-sh">~/go/src/github.com/pingcap/tidb(feature/wasm) » GOOS=js GOARCH=wasm go build -o bin/tidb.wasm tidb-server/main.go
~/go/src/github.com/pingcap/tidb(feature/wasm) » ls -l bin
total 85816
-rwxrwxr-x 1 coder coder 87868180 Dec 14 18:16 tidb.wasm
</code></pre>
<p>成功しました！</p>
<h3><a class="header" href="#互換性の問題-1" id="互換性の問題-1">互換性の問題</a></h3>
<p>コンパイル出したの<code>tidb.wasm</code>は<code>os.Stdin</code>を介して入力した<code>SQL</code>を読み取り、<code>os.Stdout</code>を介して結果を出力します。だから、ウェブページはまだブランクした。ただし、<code>TiDB</code>のログは<code>os.Stdout</code>に送られるため、ブラウザコンソールで<code>TiDB</code>の通常の起動のログを確認する必要があります。しかし、残念ながら例外のスタックトレースが表示されます。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-exception-stack.png" alt="exception-stack" /></p>
<p>このエラーが発生するの理由は<code>os.Stat</code>は実装しない。現在、<code>Golang</code>は<code>WASI</code>のサポートはあまり良くない、<code>wasm_exec.js</code>で<code>fs</code>を部分的に実装しています：</p>
<pre><code class="language-js">global.fs = {
  writeSync(fd, buf) {
    ...
  },
  write(fd, buf, offset, length, position, callback) {
    ...
  },
  open(path, flags, mode, callback) {
    ...
  },
  ...
}
</code></pre>
<p>この<code>fs</code>の実装は<code>stat</code>、<code>lstat</code>、<code>unlink</code>、<code>mkdir</code>などの呼び出しを実装しません。幸いなことに、<code>JavaScript</code>は動的プログラミング言語です、関数を<code>fs</code>に動的に追加できます。</p>
<pre><code class="language-js">function unimplemented() {
  const err = new Error('not implemented');
  err.code = 'ENOSYS';
  arguments[arguments.length - 1](err)
}

fs.stat = unimplemented;
fs.lstat = unimplemented;
fs.unlink = unimplemented;
fs.rmdir = unimplemented;
fs.mkdir = unimplemented;
go.run(result.instance);
</code></pre>
<p>ウェブページを再読み込み、起動ログがコンソールに表示されました！</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-startup-log.png" alt="startup-log" /></p>
<p>これまで、<code>TiDB</code>を<code>Wasm</code>にコンパイルするの技術的な問題はすべて解決されました。後では、以前に作成されたの<code>REPL</code>ターミナルを置き換える適切なターミナルを見つけることなら、ページに<code>SQL</code>を入力してのことはできます。</p>
<h3><a class="header" href="#ユーザーインターフェース-1" id="ユーザーインターフェース-1">ユーザーインターフェース</a></h3>
<p>上記の仕事により、<code>SQL</code>を受け入れてその実行結果を出力する<code>Exec</code>関数ができました。ブラウザで実行するには、この関数とインタラクションするためのブラウザバージョンの<code>SQL</code>ターミナルも必要です。その対策は<code>window</code>に<code>Exec</code>関数を登録する、なら<code>JavaScript</code>の関数は<code>Exec</code>呼び出すことはできます。</p>
<pre><code class="language-go">js.Global().Set(&quot;executeSQL&quot;, js.FuncOf(func(this js.Value, args []js.Value) interface{} {
	go func() {
		// Simplified code
		sql := args[0].String()
		args[1].Invoke(k.Exec(sql))
	}()
	return nil
}))
</code></pre>
<p>それで、コンソールの場合は<code>SQL</code>を実行できます。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-console-call-go-func.png" alt="console-call-go-func" /></p>
<p><code>jquery.console.js</code>を使用して<code>SQL</code>ターミナルを構築し、<code>executeSQL</code>をコールバックとして渡します。完了します！</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-show-databases.png" alt="show-databases" /></p>
<h3><a class="header" href="#ローカルファイルアクセス-1" id="ローカルファイルアクセス-1">ローカルファイルアクセス</a></h3>
<p><code>TiDB</code>には、ローカルファイルシステムにアクセスする必要があるいくつかの関数があります、例えば<a href="https://pingcap.com/docs/stable/reference/sql/statements/load-data/"><code>LOAD DATA</code></a>および<code>LOAD STATS</code>。<code>LOAD DATA</code>の機能は、ローカルファイルからデータベースにデータをインポートする。交換方法はブラウザのファイルアップロードウィンドウを使用した、<code>LOAD STATS</code>の実装は同じです。</p>
<pre><code class="language-go">js.Global().Get(&quot;upload&quot;).Invoke(js.FuncOf(func(this js.Value, args []js.Value) interface{} {
go func() {
	fileContent := args[0].String()
		_, e := doSomething(fileContent)
			c &lt;- e
	}()
	return nil
}), js.FuncOf(func(this js.Value, args []js.Value) interface{} {
	go func() {
		c &lt;- errors.New(args[0].String())
	}()
	return nil
}))
</code></pre>
<p><code>SOURCE</code>コマンドはローカルファイルを読み取り、まとは<code>MySQL</code>クライアントで実行します。<code>TiDB</code>を初めて使用するユーザーは、<code>TiDB</code>と<code>MySQL</code>の互換性を確認したいと考えています。このコマンドは、ユーザーがテストデータをすば速いインポートするのに役立ちます。</p>
<p><code>SOURCE</code>コマンドの効果を示す例として<code>test.sql</code>ファイルを取り上げます<code>test.sql</code>ファイルの内容は下記です。</p>
<pre><code class="language-sql">CREATE DATABASE IF NOT EXISTS samp_db;

USE samp_db;

CREATE TABLE IF NOT EXISTS person (
  number INT(11),
  name VARCHAR(255),
  birthday DATE
);

CREATE INDEX person_num ON person (number);

INSERT INTO person VALUES(&quot;1&quot;,&quot;tom&quot;,&quot;20170912&quot;);

UPDATE person SET birthday='20171010' WHERE name='tom';
</code></pre>
<p><code>SOURCE</code>コマンドを入力すると、ファイル選択ボックスがポップアップします。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-source-file-select.png" alt="source-file-select" /></p>
<p>選択後、<code>SQL</code>が自動的に実行され、<code>TiDB</code>のテストを続行できます。</p>
<p><img src="blog/./tidb-wasm/tidb-wasm-source-test.png" alt="source-test" /></p>
<h2><a class="header" href="#まとめと展望-1" id="まとめと展望-1">まとめと展望</a></h2>
<p>TiDBを移植するために、主にいくつかの問題を解決しました。</p>
<ul>
<li>
<p>ブラウザはポートをリスニングのことはできません。<code>SQL</code>ターミナルを<code>TiDB</code>に埋め込みました。</p>
</li>
<li>
<p><code>goleveldb</code>の<code>Wasm</code>コンパイル。</p>
</li>
<li>
<p><code>bigfft</code>の<code>Wasm</code>コンパイル。</p>
</li>
<li>
<p><code>Golang</code>は<code>WASI</code>のサポートが不完全なため、<code>fs</code>関連の機能がありません。</p>
</li>
<li>
<p><code>TiDB</code>はローカルファイルの読み込みをブラウザのアップロードファイルの読み込みに変換します。</p>
</li>
<li>
<p><code>SQL</code>をバッチで実行する<code>SOURCE</code>コマンドをサポート。</p>
</li>
</ul>
<p>現在<code>PingCAP</code>は、このプロジェクトを<a href="https://play.pingcap.com/">TiDB Playground</a>および<a href="https://tour.pingcap.com/">TiDB Tour</a>のユーザーが利用できるようにしました。ユーザーはインストールと構成を行う必要がないため、ユーザーはドキュメントを読みながら試してみることができます。これにより、ユーザーが<code>TiDB</code>は使用して学ぶ安いです。コミュニティにはすでに<code>TiDB Wasm</code>に基づくデータベースチュートリアルがあります<a href="https://github.com/imiskolee/tidb-wasm-markdown">tidb-wasm-markdown</a>。</p>
<p>このプロジェクトは<code>PingCAP Hackathon</code>で二等賞を受賞しました。スケジュールが厳しいため、まだたくさんの機能は実装されていません、例えば：</p>
<ul>
<li>
<p><code>IndexedDB</code>を使用したデータの永続化：<code>IndexedDB</code>のストレージインターフェイスのセットを実装する。</p>
</li>
<li>
<p><code>P2P</code>を使用した他のブラウザーにサービスを提供する：将来、ますます多くのアプリケーションが<code>Wasm</code>に移行されるでしょう、多くのデータベースが必要、<code>TiDB Wasm</code>を使用できます。</p>
</li>
<li>
<p><code>TiDB Wasm</code>のバイナリスリミング：現在のはほぼ<code>80MB</code>、読み込みが遅い、実行時によりたくさんのメモリを使用する、これらは最適化する必要があります。</p>
</li>
</ul>
<p>興味のあるコミュニティの友人は、このプロジェクトに参加して一緒に楽しんでください、<a href="https://github.com/pingcap/tidb/projects/27">プロジェクト</a>、<a href="mailto:info@pingcap.com">info@pingcap.com</a>でお問い合わせいただくこともできます。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
